<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Gluc√©mica ‚Äî PWA (Fix)</title>
<meta name="description" content="PWA Calculadora gluc√©mica con scanner, OFF autofill, trie, modal paginado, IndexedDB y EAN mapping" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3Eüçû%3C/text%3E%3C/svg%3E">

<!-- Quagga (barcode fallback) -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
:root{--verde:#2e8b57;--panel:#f4f7f4;--texto:#222}
body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:12px;background:#fff;color:var(--texto)}
.header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.h1{font-size:1.2rem;color:var(--verde)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.search{min-width:180px;padding:8px;border-radius:6px;border:1px solid #ccc}
.btn{background:var(--verde);color:#fff;padding:8px 10px;border-radius:8px;border:none}
.btn[disabled]{opacity:0.5;pointer-events:none}
.table-wrap{overflow:auto;border:1px solid #ddd;border-radius:8px;background:var(--panel);margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e6e6e6;text-align:center}
.unit{font-weight:600}
#resumen{margin-top:10px;padding:10px;border-radius:8px;background:#fafafa;border:1px solid #eee}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:flex-end;justify-content:center;z-index:3000}
.modal{width:100%;max-width:720px;background:#fff;border-radius:12px 12px 0 0;padding:12px;max-height:78vh;overflow:auto}
.modal .list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.modal .item{padding:10px;border-radius:8px;border:1px solid #e6e6e6;cursor:pointer}
.pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
.small{font-size:0.85rem;padding:6px 8px}
.footer{position:fixed;right:8px;bottom:8px;opacity:0.8;color:var(--verde)}
.scan-area{border:1px dashed #ccc;padding:6px;border-radius:8px;text-align:center}
.camera-preview{width:100%;height:auto;border-radius:6px;margin-top:6px}
.recipe-list{display:flex;flex-direction:column;gap:6px}
.notice{background:#fff3cd;border:1px solid #ffeeba;padding:8px;border-radius:6px;margin-top:10px}
</style>
</head>
<body>
<div class="header">
  <div><div class="h1">Calculadora Gluc√©mica ‚Äî PWA</div><div style="font-size:0.85rem;color:#666">Fix de estabilidad y EAN mapping</div></div>
  <div>
    <button class="btn" id="installBtn" style="display:none">Instalar</button>
  </div>
</div>

<div id="localNotice" class="notice" style="display:none"></div>

<div class="controls">
  <select id="tipoComida"><option>Desayuno</option><option>Merienda</option><option>Comida</option><option>Cena</option></select>
  <input id="buscador" class="search" placeholder="Buscar alimento o marca..." />
  <button class="btn" id="addBtn" disabled>Agregar alimento</button>
  <button class="btn" id="openModalBtn" disabled>Abrir selector</button>
  <button class="btn" id="scanBtn" disabled>Escanear c√≥digo (c√°mara)</button>
  <button class="btn" id="saveRecipeBtn" disabled>Guardar receta</button>
  <select id="recipesSelect" style="min-width:160px"></select>
  <button class="btn" id="loadRecipeBtn" disabled>Cargar</button>
</div>

<div class="table-wrap">
  <table id="tabla"><thead><tr><th>Alimento</th><th>Cantidad <span class="unit">(g/ml)</span></th><th>IG</th><th>Carbs (g)</th><th>CG</th><th>Kcal</th><th>Quitar</th></tr></thead><tbody id="cuerpoTabla"></tbody></table>
</div>

<div id="resumen">
  <div id="resultado">CG total: 0 | Kcal total: 0</div>
  <div>IG ponderado: <span id="igprom">0</span></div>
  <div>IRE: <span id="iretext">0</span> | VG: <span id="vgtext">0</span></div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <strong>Selecciona alimento</strong>
      <div><input id="modalSearch" placeholder="Filtrar..." class="search" style="width:200px" /></div>
    </header>
    <div id="modalList" class="list"></div>
    <div class="pager" id="modalPager"></div>
  </div>
</div>

<div style="margin-top:12px;display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap">
  <div style="min-width:220px">
    <div style="font-weight:600">Esc√°ner</div>
    <div class="scan-area" id="scanArea">
      <div id="scanStatus">Inactivo</div>
      <video id="video" class="camera-preview" autoplay muted playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
  </div>
  <div style="flex:1">
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">Recetas guardadas</div><button class="small" id="newRecipeBtn" disabled>Nueva</button></div>
    <div id="recipes" class="recipe-list"></div>
  </div>
</div>

<div class="footer">powered by <strong>Sarmiento</strong></div>

<script>
// Defensive wrapper to avoid uncaught 'catch' token issues and ensure clear error handling.
(function(){
  'use strict';

  // IndexedDB helper with proper promise error flows
  const DB_NAME = 'glucemica_pwa_v3'; const DB_VERSION = 2; let db = null;
  function openDB(){
    return new Promise((resolve,reject)=>{
      try{
        const r = indexedDB.open(DB_NAME, DB_VERSION);
        r.onupgradeneeded = function(e){
          const idb = e.target.result;
          if(!idb.objectStoreNames.contains('alimentos')) idb.createObjectStore('alimentos',{keyPath:'name'});
          if(!idb.objectStoreNames.contains('recipes')) idb.createObjectStore('recipes',{keyPath:'id'});
          if(!idb.objectStoreNames.contains('ean')) idb.createObjectStore('ean',{keyPath:'code'});
        };
        r.onsuccess = function(e){ db = e.target.result; resolve(db); };
        r.onerror = function(e){ reject(new Error('IndexedDB open failed: ' + (e.target && e.target.error ? e.target.error.message : e.message))); };
      }catch(err){ reject(err); }
    });
  }

  function idbPut(store,value){
    return new Promise((resolve,reject)=>{
      if(!db) return reject(new Error('DB not open'));
      try{
        const tx = db.transaction(store,'readwrite'); const os = tx.objectStore(store); const req = os.put(value);
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = e=>reject(e.target && e.target.error ? e.target.error : new Error('idbPut error'));
      }catch(err){ reject(err); }
    });
  }
  function idbGetAll(store){
    return new Promise((resolve,reject)=>{
      if(!db) return resolve([]);
      try{ const tx = db.transaction(store,'readonly'); const os = tx.objectStore(store); const req = os.getAll(); req.onsuccess = ()=>resolve(req.result); req.onerror = e=>reject(e.target && e.target.error ? e.target.error : new Error('idbGetAll error')); }catch(err){ reject(err); }
    });
  }
  function idbGet(store,key){
    return new Promise((resolve,reject)=>{
      if(!db) return resolve(null);
      try{ const tx = db.transaction(store,'readonly'); const os = tx.objectStore(store); const req = os.get(key); req.onsuccess = ()=>resolve(req.result); req.onerror = e=>reject(e.target && e.target.error ? e.target.error : new Error('idbGet error')); }catch(err){ reject(err); }
    });
  }

  // Seed (shortened here for readability; full seed should be included in the real file)
  const seedAlimentos = [
    {name:'Pan blanco',gi:75,carbs:49,kcal:265},
    {name:'Leche entera',gi:41,carbs:5,kcal:61,density:1.03},
    {name:'Agua',gi:0,carbs:0,kcal:0,density:1.0}
    // ... rest of seed items (omitted here for brevity)
  ];

  const liquidos_keywords = ['agua','leche','vino','cerveza','zumo','jugo','refresco','bebida','aceite','sopa','caldo','t√©','caf√©','batido','kombucha','jarabe','sirope'];

  // Trie implementation
  class TrieNode{ constructor(){ this.children = {}; this.words = []; this.end=false; }}
  class Trie{ constructor(){ this.root = new TrieNode(); } insert(word,payload){ let node=this.root; const key=word.toLowerCase(); for(const ch of key){ if(!node.children[ch]) node.children[ch]=new TrieNode(); node = node.children[ch]; if(node.words.length < 200) node.words.push(payload); } node.end=true; } searchPrefix(prefix){ let node=this.root; const key=(prefix||'').toLowerCase(); for(const ch of key){ if(!node.children[ch]) return []; node = node.children[ch]; } return node.words || []; }}
  let trie = new Trie();

  // Modal / UI helpers
  const PAGE_SIZE = 30; let modalPage = 0; let currentFilter = '';
  function openModal(){ document.getElementById('modalOverlay').style.display='flex'; document.getElementById('modalSearch').value=''; modalPage=0; renderModal(); }
  function closeModal(e){ if(e && e.target && e.target.id==='modalOverlay'){ document.getElementById('modalOverlay').style.display='none'; } else { document.getElementById('modalOverlay').style.display='none'; } }
  async function renderModal(){
    const list = document.getElementById('modalList'); list.innerHTML = '';
    try{
      const results = currentFilter ? trie.searchPrefix(currentFilter) : await idbGetAll('alimentos');
      const start = modalPage * PAGE_SIZE; const page = results.slice(start, start+PAGE_SIZE);
      page.forEach(item=>{ const d = document.createElement('div'); d.className='item'; d.innerText = item.name; d.onclick = ()=>{ addRowWithAlimento(item.name); closeModal(); }; list.appendChild(d); });
      renderPager(results.length);
    }catch(err){ console.error('renderModal error', err); list.innerHTML = '<div class="item">Error cargando elementos</div>'; }
  }
  function renderPager(total){ const pager = document.getElementById('modalPager'); pager.innerHTML=''; const pages = Math.max(1, Math.ceil(total/PAGE_SIZE)); if(pages<=1) return; const prev = document.createElement('button'); prev.className='small'; prev.innerText='¬´'; prev.onclick = ()=>{ if(modalPage>0) modalPage--, renderModal(); }; const next = document.createElement('button'); next.className='small'; next.innerText='¬ª'; next.onclick = ()=>{ if(modalPage < pages-1) modalPage++, renderModal(); }; pager.appendChild(prev); const span=document.createElement('span'); span.innerText = ' ' + (modalPage+1) + ' / ' + pages + ' '; pager.appendChild(span); pager.appendChild(next); }

  // Table row handling
  function addRowWithAlimento(name){ try{
    const tbody = document.getElementById('cuerpoTabla'); const tr = document.createElement('tr'); const tdName = document.createElement('td'); tdName.innerText = name; tdName.dataset.name = name;
    const tdQty = document.createElement('td'); const inp = document.createElement('input'); inp.type='number'; inp.value = 100; inp.style.width='80px'; tdQty.appendChild(inp);
    const tdIG = document.createElement('td'); const tdCarbs = document.createElement('td'); const tdCG = document.createElement('td'); const tdKcal = document.createElement('td');
    const tdQ = document.createElement('td'); const btn = document.createElement('button'); btn.className='small'; btn.innerText='Quitar'; btn.onclick = ()=>{ tr.remove(); recalcAll(); };
    tdQ.appendChild(btn);
    tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdIG); tr.appendChild(tdCarbs); tr.appendChild(tdCG); tr.appendChild(tdKcal); tr.appendChild(tdQ);
    tbody.appendChild(tr);
    inp.addEventListener('input', recalcAll);
    recalcAll();
  }catch(err){ console.error('addRow error',err); }
  }

  async function recalcAll(){
    try{
      const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
      let CG_total=0, kcal_total=0, carbs_total=0, ig_pes_num=0;
      for(const tr of filas){
        const name = tr.children[0].dataset.name;
        const qty = Number(tr.querySelector('input').value) || 0;
        const item = await idbGet('alimentos', name) || seedAlimentos.find(a=>a.name===name);
        if(!item){ tr.children[2].innerText='-'; tr.children[3].innerText='0'; tr.children[4].innerText='0'; tr.children[5].innerText='0'; continue; }
        const unitMl = !!item.density;
        const gramos = unitMl ? qty * (item.density || 1) : qty;
        const carbs_g = gramos * (item.carbs/100);
        const cg_line = (item.gi * carbs_g)/100;
        const kcal_line = gramos * (item.kcal/100);
        tr.children[2].innerText = item.gi;
        tr.children[3].innerText = round(carbs_g,2);
        tr.children[4].innerText = round(cg_line,2);
        tr.children[5].innerText = round(kcal_line,1);
        CG_total += cg_line; kcal_total += kcal_line; carbs_total += carbs_g; ig_pes_num += (item.gi * carbs_g);
      }
      const ig_ponderado = carbs_total ? (ig_pes_num / carbs_total) : 0;
      const perfil = JSON.parse(localStorage.getItem('perfilUsuario') || 'null');
      const peso = perfil ? Number(perfil.peso) : 70;
      const ire = peso ? (CG_total / peso) : 0;
      const vg = kcal_total ? ((CG_total / kcal_total) * 100) : 0;
      document.getElementById('resultado').innerText = 'CG total: ' + round(CG_total,2) + ' | Kcal total: ' + Math.round(kcal_total);
      document.getElementById('igprom').innerText = round(ig_ponderado,1);
      document.getElementById('iretext').innerText = round(ire,2);
      document.getElementById('vgtext').innerText = round(vg,2);
    }catch(err){ console.error('recalcAll error',err); }
  }
  function round(v,d=2){ return Math.round(v*Math.pow(10,d))/Math.pow(10,d); }

  // Seed DB & build trie
  async function seedAndBuild(){
    try{
      await openDB();
      const existing = await idbGetAll('alimentos');
      if(!existing || existing.length === 0){
        for(const a of seedAlimentos){
          await idbPut('alimentos', a);
        }
      }
      const all = await idbGetAll('alimentos'); trie = new Trie(); all.forEach(a=> trie.insert(a.name, a));
      await rebuildRecipesSelect(); enableUI(); console.log('DB seeded and trie built');
    }catch(err){ console.error('seedAndBuild error',err); enableUI(); }
  }

  // Recipes
  async function saveRecipe(){ try{ const name = prompt('Nombre de la receta/plantilla'); if(!name) return; const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr')).map(tr=>({name: tr.children[0].dataset.name, qty: Number(tr.querySelector('input').value) || 0})); const id = 'r_' + Date.now(); await idbPut('recipes', {id, name, rows: filas, tipo: document.getElementById('tipoComida').value}); alert('Receta guardada'); await rebuildRecipesSelect(); }catch(err){ console.error('saveRecipe error',err); } }
  async function rebuildRecipesSelect(){ try{ const sel = document.getElementById('recipesSelect'); sel.innerHTML=''; sel.appendChild(new Option('-- recargas --','')); const all = await idbGetAll('recipes'); all.forEach(r=> sel.appendChild(new Option(r.name, r.id))); const list = document.getElementById('recipes'); list.innerHTML=''; all.forEach(r=>{ const d = document.createElement('div'); d.innerText = r.name + ' ('+ r.rows.length + ' items)'; const btn = document.createElement('button'); btn.className='small'; btn.innerText='Cargar'; btn.onclick = ()=> loadRecipeById(r.id); d.appendChild(btn); list.appendChild(d); }); }catch(err){ console.error('rebuildRecipesSelect error',err); } }
  async function loadRecipeById(id){ try{ const r = await idbGet('recipes', id); if(!r) return; document.getElementById('tipoComida').value = r.tipo || 'Comida'; document.getElementById('cuerpoTabla').innerHTML=''; r.rows.forEach(row=> addRowWithAlimento(row.name)); setTimeout(()=>{ r.rows.forEach((row,i)=>{ const tr = document.querySelectorAll('#cuerpoTabla tr')[i]; if(tr) tr.querySelector('input').value = row.qty; }); recalcAll(); },50); }catch(err){ console.error('loadRecipeById error',err); } }

  // EAN mapping
  async function saveEANMapping(code,name){ try{ await idbPut('ean',{code: String(code), name}); }catch(err){ console.warn('saveEANMapping failed',err); } }
  async function getEANMapping(code){ try{ return await idbGet('ean', String(code)); }catch(err){ return null; } }

  // Camera / barcode
  let scanning = false; const video = document.getElementById('video'); const scanStatus = document.getElementById('scanStatus'); let quaggaRunning = false;
  function isSecureContextAllowed(){ try{ const host = location.hostname; const proto = location.protocol; if(proto === 'https:' || host === 'localhost' || host === '127.0.0.1') return true; return false; }catch(e){ return false; } }

  async function startScanner(){
    if(!isSecureContextAllowed()){
      alert('La c√°mara s√≥lo funciona en HTTPS o en localhost/127.0.0.1. Si est√°s abriendo el archivo con file://, prueba sirvi√©ndolo con un servidor local (p.ej. npx serve)');
      return;
    }
    if(scanning) return stopScanner();
    const constraints = { video: { facingMode: 'environment' } };
    try{
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; video.style.display='block'; scanStatus.innerText='Buscando...'; scanning = true; detectFrame();
      if(window.Quagga && !quaggaRunning){
        try{
          Quagga.init({ inputStream: { type: 'LiveStream', target: video }, decoder: { readers: ['ean_reader','ean_8_reader','code_128_reader','upc_reader'] } }, function(err){ if(!err){ Quagga.start(); quaggaRunning = true; Quagga.onDetected(function(data){ if(data && data.codeResult && data.codeResult.code){ handleScannedCode(data.codeResult.code); stopScanner(); } }); } else { console.warn('Quagga init error',err); } });
        }catch(err){ console.warn('Quagga init fail',err); }
      }
    }catch(err){ alert('No se pudo acceder a la c√°mara: ' + (err && err.message ? err.message : err)); }
  }
  async function stopScanner(){ scanning = false; scanStatus.innerText='Inactivo'; video.style.display='none'; if(video.srcObject){ const tracks = video.srcObject.getTracks(); tracks.forEach(t=>t.stop()); video.srcObject = null; } if(window.Quagga && quaggaRunning){ try{ Quagga.stop(); }catch(e){} quaggaRunning = false; } }

  async function detectFrame(){ if(!scanning) return; try{ if('BarcodeDetector' in window){ const detector = new BarcodeDetector({formats:['ean_13','ean_8','qr_code','code_128','upc_e','upc_a']}); const barcodes = await detector.detect(video); if(barcodes && barcodes.length){ const code = barcodes[0].rawValue; handleScannedCode(code); await stopScanner(); return; } } }catch(err){ console.warn('BarcodeDetector error',err); } requestAnimationFrame(detectFrame); }

  // Handle scanned code
  async function handleScannedCode(code){
    try{
      scanStatus.innerText = 'Escaneado: ' + code;
      const mapped = await getEANMapping(code);
      if(mapped && mapped.name){ addRowWithAlimento(mapped.name); alert('Producto agregado desde mapeo local: ' + mapped.name); return; }
      const url = 'https://es.openfoodfacts.org/api/v0/product/' + encodeURIComponent(code) + '.json';
      const resp = await fetch(url).catch(()=>null);
      if(resp && resp.ok){ const data = await resp.json().catch(()=>null); if(data && data.product){ const p = data.product; const name = p.product_name || p.generic_name || ('Producto ' + code); const nutriments = p.nutriments || {}; const carbs100 = nutriments.carbohydrates_100g || nutriments.carbohydrates || 10; const kcal100 = nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || nutriments['energy_100g'] || 100; const gi = 50; const item = { name: name, gi: gi, carbs: carbs100, kcal: kcal100, density: null }; await idbPut('alimentos', item); trie.insert(item.name, item); await saveEANMapping(code, item.name); addRowWithAlimento(item.name); alert('Producto agregado desde OpenFoodFacts: ' + item.name + '
Se guard√≥ el mapeo EAN local. Revisa valores (IG por defecto=' + item.gi + ')'); return; } }
      // fallback: open search page
      window.open('https://es.openfoodfacts.org/cgi/search.pl?search_terms=' + encodeURIComponent(code) + '&search_simple=1&action=process&json=1','_blank');
    }catch(err){ console.warn('handleScannedCode error',err); window.open('https://es.openfoodfacts.org/cgi/search.pl?search_terms=' + encodeURIComponent(code) + '&search_simple=1&action=process&json=1','_blank'); }
  }

  async function autofillByName(name){ try{ const q = encodeURIComponent(name.split('(')[0].trim()); const url = 'https://es.openfoodfacts.org/cgi/search.pl?search_terms=' + q + '&search_simple=1&action=process&json=1&page_size=5'; const resp = await fetch(url).catch(()=>null); if(!resp || !resp.ok) return null; const data = await resp.json().catch(()=>null); if(data && data.products && data.products.length){ const prod = data.products[0]; const nutriments = prod.nutriments || {}; const carbs100 = nutriments['carbohydrates_100g'] || nutriments['carbohydrates'] || 10; const kcal100 = nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 100; const newItem = { name: prod.product_name || name, gi: prod.glycemic_index || 50, carbs: carbs100, kcal: kcal100 }; await idbPut('alimentos', newItem); trie.insert(newItem.name, newItem); return newItem; } }catch(err){ console.warn('autofillByName error',err); } return null; }

  // UI enable/disable
  function disableUI(){ ['addBtn','openModalBtn','scanBtn','saveRecipeBtn','loadRecipeBtn','newRecipeBtn'].forEach(id=>{ const el = document.getElementById(id); if(el) el.disabled = true; }); }
  function enableUI(){ ['addBtn','openModalBtn','scanBtn','saveRecipeBtn','loadRecipeBtn','newRecipeBtn'].forEach(id=>{ const el = document.getElementById(id); if(el) el.disabled = false; }); }

  // Wiring
  document.getElementById('openModalBtn').addEventListener('click', ()=>openModal());
  document.getElementById('modalSearch').addEventListener('input', e=>{ currentFilter = e.target.value.trim().toLowerCase(); modalPage = 0; renderModal(); });
  document.getElementById('buscador').addEventListener('input', e=>{ currentFilter = e.target.value.trim().toLowerCase(); modalPage = 0; renderModal(); });
  document.getElementById('addBtn').addEventListener('click', async ()=>{ const q = document.getElementById('buscador').value.trim(); if(!q) return openModal(); const results = trie.searchPrefix(q.toLowerCase()); if(results.length===1) addRowWithAlimento(results[0].name); else openModal(); });
  document.getElementById('scanBtn').addEventListener('click', ()=> startScanner());
  document.getElementById('saveRecipeBtn').addEventListener('click', ()=> saveRecipe());
  document.getElementById('loadRecipeBtn').addEventListener('click', ()=>{ const id = document.getElementById('recipesSelect').value; if(id) loadRecipeById(id); });
  document.getElementById('newRecipeBtn').addEventListener('click', ()=>{ document.getElementById('cuerpoTabla').innerHTML=''; recalcAll(); });

  // Manifest + SW (register only on http/https)
  try{
    const manifest = { name:'Calculadora Gluc√©mica', short_name:'Glucemica', start_url:'.', display:'standalone', background_color:'#ffffff', description:'PWA Calculadora gluc√©mica', icons:[{src:'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"%3E%3Ctext y="14" font-size="14"%3Eüçû%3C/text%3E%3C/svg%3E', sizes:'64x64', type:'image/svg+xml'}] };
    const manifestBlob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href = manifestURL; document.head.appendChild(link);

    const SW_CACHE = 'glucemica-shell-v3';
    const swCode = "self.addEventListener('install',function(e){e.waitUntil(self.skipWaiting());});
" +
      "self.addEventListener('fetch',function(e){ /* simple passthrough SW for offline shell */ });
";
    const swBlob = new Blob([swCode],{type:'application/javascript'});
    const swURL = URL.createObjectURL(swBlob);
    if(location.protocol !== 'file:' && 'serviceWorker' in navigator){ navigator.serviceWorker.register(swURL).then(function(){ console.log('SW registered'); }).catch(function(err){ console.warn('SW failed',err); }); } else { document.getElementById('localNotice').style.display='block'; document.getElementById('localNotice').innerText = 'Est√°s abriendo el archivo localmente (file://). Para usar c√°mara y service worker debes servir la app por HTTP(S) o usar localhost. Sirve el directorio con npx serve o similar.'; }
  }catch(err){ console.warn('manifest/SW init error',err); }

  // Install prompt handling
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', function(e){ e.preventDefault(); deferredPrompt = e; var btn = document.getElementById('installBtn'); btn.style.display = 'inline-block'; btn.onclick = function(){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(function(choice){ console.log('Install choice',choice); btn.style.display='none'; deferredPrompt = null; }); }; });

  // Init
  disableUI();
  seedAndBuild().then(function(){ console.log('Seed & build done'); }).catch(function(e){ console.warn(e); enableUI(); });

  // Tests (keep existing tests and add EAN roundtrip)
  function basicTests(){ try{ console.log('Running PWA tests'); console.assert(typeof trie.searchPrefix === 'function', 'Trie exists'); addRowWithAlimento('Pan blanco'); addRowWithAlimento('Leche entera'); const filas = document.querySelectorAll('#cuerpoTabla tr'); console.assert(filas.length >= 2, 'Rows added'); console.log('Basic tests OK'); }catch(e){ console.error('Tests error',e); } }
  setTimeout(basicTests,1500);

  async function asyncTests(){ try{ console.log('Running async tests'); await saveEANMapping('0000000000000','Pan blanco'); const mapped = await getEANMapping('0000000000000'); console.assert(mapped && mapped.name === 'Pan blanco', 'EAN mapping saved and retrieved'); console.log('Async tests OK'); }catch(e){ console.error('Async tests error',e); } }
  setTimeout(asyncTests,2500);

})();
</script>
</body>
</html>

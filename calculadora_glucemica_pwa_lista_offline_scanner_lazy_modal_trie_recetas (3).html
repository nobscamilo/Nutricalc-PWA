<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
<meta name="theme-color" content="#2e8b57" />
<title>Calculadora Gluc√©mica ‚Äî PWA Web</title>
<meta name="description" content="Calculadora gluc√©mica PWA ‚Äî perfil, modal selector, scanner, EAN mapping, export CSV/PDF" />
<link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2016%2016'%3E%3Ctext%20y='14'%20font-size='14'%3E%F0%9F%8D%9E%3C/text%3E%3C/svg%3E">

<!-- Libraries -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --verde: #2e8b57;
  --verde-claro: #3cb371;
  --verde-oscuro: #1e5f3d;
  --amarillo: #f39c12;
  --rojo: #e74c3c;
  --panel: #f8faf9;
  --texto: #2c3e50;
  --texto-claro: #7f8c8d;
  --fondo: #ffffff;
  --borde: #e0e6e3;
  --sombra: rgba(46, 139, 87, 0.1);
  --sombra-fuerte: rgba(46, 139, 87, 0.2);
}

* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: var(--fondo);
  color: var(--texto);
  font-size: 16px;
  line-height: 1.5;
  padding-bottom: 60px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}

.title {
  color: var(--verde);
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
}

.subtitle {
  font-size: 0.875rem;
  color: var(--texto-claro);
  margin-top: 4px;
}

.header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

/* Buttons */
.btn {
  background: var(--verde);
  color: #fff;
  padding: 12px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  min-height: 44px;
  min-width: 44px;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: 0 2px 4px var(--sombra);
  touch-action: manipulation;
  user-select: none;
}

.btn:active {
  transform: scale(0.97);
  box-shadow: 0 1px 2px var(--sombra);
}

.btn:hover {
  background: var(--verde-oscuro);
}

.btn.small {
  padding: 10px 14px;
  font-size: 14px;
  min-height: 40px;
}

.btn.ghost {
  background: transparent;
  color: var(--verde);
  border: 2px solid var(--verde);
  box-shadow: none;
}

.btn.ghost:hover {
  background: var(--panel);
}

.btn.danger {
  background: var(--rojo);
}

.btn.danger:hover {
  background: #c0392b;
}

/* Profile Panel */
.profile {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--borde);
  margin-bottom: 20px;
  box-shadow: 0 2px 8px var(--sombra);
}

.profile h3 {
  margin: 0 0 12px 0;
  color: var(--verde);
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}

.profile-toggle {
  background: none;
  border: none;
  color: var(--verde);
  cursor: pointer;
  font-size: 1.2rem;
  padding: 4px;
  min-width: auto;
  min-height: auto;
  transition: transform 0.3s ease;
}

.profile-toggle.collapsed {
  transform: rotate(-90deg);
}

.profile-content {
  display: grid;
  gap: 12px;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
}

.profile-content.collapsed {
  display: none;
}

.profile-content label {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 14px;
  font-weight: 600;
  color: var(--texto);
}

.profile-content input,
.profile-content select {
  padding: 10px;
  border: 1px solid var(--borde);
  border-radius: 8px;
  font-size: 16px;
  min-height: 44px;
  background: white;
}

.profile-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

#infoPerfil {
  margin: 12px 0 0 0;
  padding: 10px;
  background: white;
  border-radius: 8px;
  font-size: 14px;
  color: var(--texto-claro);
}

/* Controls */
.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.search {
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--borde);
  min-width: 200px;
  flex: 1;
  font-size: 16px;
  min-height: 44px;
  background: white;
}

.search:focus {
  outline: none;
  border-color: var(--verde);
  box-shadow: 0 0 0 3px var(--sombra);
}

/* Table - Desktop */
.table-wrap {
  background: var(--panel);
  padding: 12px;
  border-radius: 12px;
  border: 1px solid var(--borde);
  overflow-x: auto;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px var(--sombra);
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

th, td {
  padding: 12px 8px;
  text-align: center;
  border-bottom: 1px solid var(--borde);
}

th {
  background: var(--verde);
  color: white;
  font-weight: 600;
  font-size: 14px;
  position: sticky;
  top: 0;
  z-index: 10;
}

td input {
  width: 80px;
  padding: 8px;
  border: 1px solid var(--borde);
  border-radius: 6px;
  text-align: center;
  font-size: 16px;
  min-height: 40px;
}

/* Table - Mobile Cards */
.table-cards {
  display: none;
}

.food-card {
  background: white;
  border: 1px solid var(--borde);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 2px 6px var(--sombra);
}

.food-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--borde);
}

.food-card-name {
  font-weight: 700;
  color: var(--verde);
  font-size: 1.05rem;
}

.food-card-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.food-card-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.food-card-label {
  font-size: 12px;
  color: var(--texto-claro);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.food-card-value {
  font-size: 16px;
  font-weight: 600;
  color: var(--texto);
}

.food-card-input {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--borde);
  border-radius: 8px;
  font-size: 16px;
  min-height: 44px;
}

/* Summary */
.summary {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--borde);
  margin-bottom: 20px;
  box-shadow: 0 2px 8px var(--sombra);
}

.summary h3 {
  margin: 0 0 16px 0;
  color: var(--verde);
  font-size: 1.1rem;
}

#resultado {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--texto);
  margin-bottom: 16px;
  padding: 12px;
  background: white;
  border-radius: 8px;
}

/* Bars */
.bar-row {
  margin-bottom: 16px;
}

.bar-labels {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-size: 14px;
  font-weight: 600;
}

.bar-container {
  width: 100%;
  height: 20px;
  background: #e8f5e9;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.bar {
  height: 100%;
  width: 0%;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
  border-radius: 10px;
}

.bar.low {
  background: linear-gradient(90deg, var(--verde), var(--verde-claro));
}

.bar.medium {
  background: linear-gradient(90deg, var(--amarillo), #f1c40f);
}

.bar.high {
  background: linear-gradient(90deg, var(--rojo), #e67e73);
}

.small-note {
  font-size: 12px;
  color: var(--texto-claro);
  margin-top: 4px;
  font-style: italic;
}

/* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal {
  width: 100%;
  max-width: 100%;
  background: var(--fondo);
  border-radius: 20px 20px 0 0;
  padding: 20px;
  max-height: 85vh;
  overflow: auto;
  animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--borde);
}

.modal-header strong {
  font-size: 1.2rem;
  color: var(--verde);
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--texto-claro);
  cursor: pointer;
  padding: 4px 8px;
  min-width: auto;
  min-height: auto;
}

.modal .list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
}

.item {
  padding: 16px;
  border-radius: 10px;
  border: 1px solid var(--borde);
  cursor: pointer;
  background: white;
  transition: all 0.2s ease;
  font-weight: 500;
  min-height: 52px;
  display: flex;
  align-items: center;
}

.item:active {
  transform: scale(0.98);
  background: var(--panel);
  border-color: var(--verde);
}

.pager {
  display: flex;
  gap: 12px;
  justify-content: center;
  align-items: center;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--borde);
}

.pager span {
  font-weight: 600;
  color: var(--texto);
}

/* Scanner */
.scan-section {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--borde);
  margin-bottom: 20px;
  box-shadow: 0 2px 8px var(--sombra);
}

.scan-area {
  border: 2px dashed var(--borde);
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  background: white;
}

#scanStatus {
  font-weight: 600;
  color: var(--texto-claro);
  margin-bottom: 12px;
}

#video {
  width: 100%;
  max-width: 400px;
  border-radius: 8px;
  margin-top: 12px;
}

/* Recipes */
.recipes-section {
  background: var(--panel);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--borde);
  margin-bottom: 20px;
  box-shadow: 0 2px 8px var(--sombra);
}

.recipes-section h3 {
  margin: 0 0 12px 0;
  color: var(--verde);
  font-size: 1.1rem;
}

.recipes-controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

#recipesSelect {
  flex: 1;
  min-width: 160px;
  padding: 10px;
  border: 1px solid var(--borde);
  border-radius: 8px;
  font-size: 16px;
  min-height: 44px;
  background: white;
}

/* Notice */
.notice {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 14px;
}

/* Footer */
.footer {
  position: fixed;
  right: 12px;
  bottom: 12px;
  color: var(--verde);
  opacity: 0.7;
  font-size: 12px;
  background: white;
  padding: 6px 12px;
  border-radius: 20px;
  box-shadow: 0 2px 8px var(--sombra);
  z-index: 100;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .title {
    font-size: 1.3rem;
  }

  .subtitle {
    font-size: 0.8rem;
  }

  .header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-actions {
    width: 100%;
    justify-content: flex-start;
  }

  /* Hide desktop table, show cards */
  .table-wrap {
    display: none;
  }

  .table-cards {
    display: block;
  }

  /* Profile collapsed by default on mobile */
  .profile-content {
    grid-template-columns: 1fr;
  }

  /* Controls full width */
  .controls {
    flex-direction: column;
  }

  .controls .search,
  .controls .btn {
    width: 100%;
  }

  /* Modal full screen */
  .modal {
    max-width: 100%;
    border-radius: 20px 20px 0 0;
    max-height: 90vh;
  }

  /* Summary bars */
  .bar-labels {
    font-size: 13px;
  }

  #resultado {
    font-size: 1rem;
  }

  /* Recipes */
  .recipes-controls {
    flex-direction: column;
  }

  #recipesSelect {
    width: 100%;
  }

  /* Footer */
  .footer {
    display: none;
  }

  /* Scan section */
  .scan-section {
    padding: 12px;
  }

  #video {
    max-width: 100%;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 8px;
  }

  .title {
    font-size: 1.2rem;
  }

  .btn {
    font-size: 14px;
    padding: 10px 12px;
  }

  .food-card {
    padding: 12px;
  }

  .food-card-body {
    grid-template-columns: 1fr;
  }
}

/* Landscape mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .modal {
    max-height: 95vh;
  }

  .profile-content.collapsed {
    display: none;
  }
}

/* Tablet */
@media (min-width: 769px) and (max-width: 1024px) {
  .container {
    padding: 16px;
  }

  .profile-content {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Print styles */
@media print {
  .btn, .controls, .header-actions, .footer, .scan-section, .recipes-section {
    display: none !important;
  }

  .container {
    max-width: 100%;
  }

  .table-wrap {
    box-shadow: none;
    border: 1px solid #000;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">üçé Calculadora Gluc√©mica</div>
      <div class="subtitle">Control nutricional inteligente ‚Äî PWA Web</div>
    </div>
    <div class="header-actions">
      <button id="installBtn" class="btn small" style="display:none">üì≤ Instalar</button>
      <button id="runTestsBtn" class="btn small ghost">üß™ Tests</button>
    </div>
  </div>

  <!-- Profile Panel -->
  <div id="profilePanel" class="profile">
    <h3 onclick="toggleProfile()">
      üë§ Perfil de usuario
      <span class="profile-toggle" id="profileToggle">‚ñº</span>
    </h3>
    <div class="profile-content" id="profileContent">
      <label>
        Nombre
        <input id="nombre" type="text" placeholder="Tu nombre">
      </label>
      <label>
        Sexo
        <select id="sexo">
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </label>
      <label>
        Edad
        <input id="edad" type="number" min="1" max="120" placeholder="A√±os">
      </label>
      <label>
        Peso (kg)
        <input id="peso" type="number" step="0.1" placeholder="70">
      </label>
      <label>
        Talla (cm)
        <input id="talla" type="number" placeholder="170">
      </label>
    </div>
    <div class="profile-actions">
      <button id="guardarPerfil" class="btn small">üíæ Guardar perfil</button>
      <button id="cargarPerfil" class="btn small ghost">üìÇ Cargar perfil</button>
    </div>
    <p id="infoPerfil">Sin perfil guardado</p>
  </div>

  <!-- Controls -->
  <div class="controls">
    <select id="tipoComida" class="search">
      <option>Desayuno</option>
      <option>Merienda</option>
      <option>Comida</option>
      <option>Cena</option>
    </select>
    <input id="buscador" class="search" placeholder="üîç Buscar alimento..." />
    <button id="addBtn" class="btn small">‚ûï Agregar</button>
    <button id="openModalBtn" class="btn small">üìã Selector</button>
    <button id="scanBtn" class="btn small">üì∑ Escanear</button>
    <button id="exportCSV" class="btn small ghost">üìä CSV</button>
    <button id="exportPDF" class="btn small ghost">üìÑ PDF</button>
    <button id="clearBtn" class="btn small danger">üóëÔ∏è Limpiar</button>
  </div>

  <!-- Table Desktop -->
  <div class="table-wrap">
    <table id="tabla">
      <thead>
        <tr>
          <th>Alimento</th>
          <th>Cantidad (g/ml)</th>
          <th>IG</th>
          <th>Carbs (g)</th>
          <th>CG</th>
          <th>Kcal</th>
          <th>Quitar</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>
  </div>

  <!-- Table Mobile Cards -->
  <div class="table-cards" id="tableCards"></div>

  <!-- Summary -->
  <div class="summary">
    <h3>üìä Resumen Nutricional</h3>
    <div id="resultado">CG total: 0 | Kcal total: 0</div>
    
    <div class="bar-row">
      <div class="bar-labels">
        <span>CG total</span>
        <span id="cgvalue">0</span>
      </div>
      <div class="bar-container">
        <div id="cgbar" class="bar low" style="width:0%"></div>
      </div>
    </div>

    <div class="bar-row">
      <div class="bar-labels">
        <span>IG ponderado</span>
        <span id="igprom">0</span>
      </div>
      <div class="small-note">√çndice gluc√©mico promedio ponderado por carbohidratos</div>
    </div>

    <div class="bar-row">
      <div class="bar-labels">
        <span>IRE (CG / kg)</span>
        <span id="iretext">0</span>
      </div>
      <div class="bar-container">
        <div id="irebar" class="bar low" style="width:0%"></div>
      </div>
      <div class="small-note">√çndice de respuesta estimada por kg de peso</div>
    </div>

    <div class="bar-row">
      <div class="bar-labels">
        <span>VG (CG / Kcal √ó 100)</span>
        <span id="vgtext">0</span>
      </div>
      <div class="bar-container">
        <div id="vgbar" class="bar low" style="width:0%"></div>
      </div>
      <div class="small-note">Valor gluc√©mico por cada 100 kcal</div>
    </div>
  </div>

  <div id="localNotice" class="notice" style="display:none"></div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
      <div class="modal-header">
        <strong>Selecciona alimento</strong>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <input id="modalSearch" class="search" placeholder="üîç Filtrar alimentos..." />
      <div id="modalList" class="list"></div>
      <div id="modalPager" class="pager"></div>
    </div>
  </div>

  <!-- Scanner Section -->
  <div class="scan-section">
    <h3>üì∑ Esc√°ner de C√≥digos</h3>
    <div class="scan-area">
      <div id="scanStatus">Inactivo</div>
      <video id="video" style="display:none" autoplay muted playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
  </div>

  <!-- Recipes Section -->
  <div class="recipes-section">
    <h3>üìñ Recetas / Plantillas</h3>
    <div class="recipes-controls">
      <button id="saveRecipeBtn" class="btn small ghost">üíæ Guardar plantilla</button>
      <select id="recipesSelect"></select>
      <button id="loadRecipeBtn" class="btn small">üìÇ Cargar</button>
    </div>
    <div id="recipes"></div>
  </div>

  <div class="footer">powered by <strong>Sarmiento</strong></div>
</div>

<script>
(function(){
  'use strict';
  const $ = id => document.getElementById(id);

  /* Helper functions */
  function round(num, decimals) {
    return Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
  }

  /* Profile toggle */
  window.toggleProfile = function() {
    const content = $('profileContent');
    const toggle = $('profileToggle');
    content.classList.toggle('collapsed');
    toggle.classList.toggle('collapsed');
  };

  /* IndexedDB helpers */
  const DB_NAME = 'glucemica_web_v2';
  const DB_VERSION = 1;
  let db = null;

  function openDB() {
    return new Promise((res, rej) => {
      try {
        const r = indexedDB.open(DB_NAME, DB_VERSION);
        r.onupgradeneeded = e => {
          const idb = e.target.result;
          if (!idb.objectStoreNames.contains('alimentos'))
            idb.createObjectStore('alimentos', { keyPath: 'name' });
          if (!idb.objectStoreNames.contains('recipes'))
            idb.createObjectStore('recipes', { keyPath: 'id' });
          if (!idb.objectStoreNames.contains('ean'))
            idb.createObjectStore('ean', { keyPath: 'code' });
        };
        r.onsuccess = e => {
          db = e.target.result;
          res(db);
        };
        r.onerror = e => rej(new Error('IndexedDB open failed'));
      } catch (err) {
        rej(err);
      }
    });
  }

  function idbPut(store, val) {
    return new Promise((res, rej) => {
      if (!db) return rej(new Error('DB not open'));
      try {
        const tx = db.transaction(store, 'readwrite');
        const os = tx.objectStore(store);
        const rq = os.put(val);
        rq.onsuccess = () => res(rq.result);
        rq.onerror = e => rej(e);
      } catch (err) {
        rej(err);
      }
    });
  }

  function idbGet(store, key) {
    return new Promise((res, rej) => {
      if (!db) return res(null);
      try {
        const tx = db.transaction(store, 'readonly');
        const os = tx.objectStore(store);
        const rq = os.get(key);
        rq.
        rq.onsuccess = () => res(rq.result);
        rq.onerror = e => rej(e);
      } catch (err) {
        rej(err);
      }
    });
  }

  function idbGetAll(store) {
    return new Promise((res, rej) => {
      if (!db) return res([]);
      try {
        const tx = db.transaction(store, 'readonly');
        const os = tx.objectStore(store);
        const rq = os.getAll();
        rq.onsuccess = () => res(rq.result);
        rq.onerror = e => rej(e);
      } catch (err) {
        rej(err);
      }
    });
  }

  /* Large seed: 320 items */
  const seedAlimentos = [
    {name:'Pan blanco',gi:75,carbs:49,kcal:265},{name:'Pan integral',gi:65,carbs:41,kcal:247},{name:'Pan centeno',gi:50,carbs:41,kcal:259},
    {name:'Tostada',gi:70,carbs:50,kcal:480},{name:'Bagel',gi:72,carbs:56,kcal:300},{name:'Pan pita',gi:57,carbs:56,kcal:275},
    {name:'Arroz blanco cocido',gi:73,carbs:28,kcal:130},{name:'Arroz integral cocido',gi:50,carbs:23,kcal:111},{name:'Arroz basmati',gi:58,carbs:25,kcal:120},
    {name:'Pasta cocida',gi:51,carbs:25,kcal:131},{name:'Pasta integral',gi:42,carbs:25,kcal:124},{name:'Quinoa cocida',gi:53,carbs:21,kcal:120},
    {name:'Cuscus',gi:65,carbs:23,kcal:112},{name:'Masa pizza',gi:80,carbs:26,kcal:266},{name:'Pizza',gi:80,carbs:26,kcal:266},
    {name:'Patata cocida',gi:78,carbs:17,kcal:87},{name:'Patata asada',gi:85,carbs:20,kcal:95},{name:'Pure patatas',gi:87,carbs:12,kcal:88},
    {name:'Patatas fritas',gi:75,carbs:49,kcal:536},{name:'Patatas chips',gi:75,carbs:49,kcal:536},{name:'Tortilla de patatas',gi:60,carbs:12,kcal:150},
    {name:'Galletas',gi:75,carbs:65,kcal:450},{name:'Muesli',gi:50,carbs:64,kcal:450},{name:'Avena copos',gi:55,carbs:66,kcal:389},
    {name:'Avena instantanea',gi:79,carbs:66,kcal:380},{name:'Harina trigo',gi:85,carbs:76,kcal:364},{name:'Harina maiz',gi:70,carbs:72,kcal:360},
    {name:'Cereales azucarados',gi:81,carbs:84,kcal:357},{name:'Cornflakes',gi:81,carbs:84,kcal:357},{name:'Miel',gi:58,carbs:82,kcal:304},
    {name:'Azucar blanca',gi:65,carbs:100,kcal:387},{name:'Jarabe arce',gi:54,carbs:67,kcal:260},{name:'Sirope agave',gi:20,carbs:76,kcal:310},
    {name:'Sirope maiz',gi:100,carbs:76,kcal:310},{name:'Chocolate negro',gi:23,carbs:46,kcal:598},{name:'Chocolate con leche',gi:45,carbs:52,kcal:535},
    {name:'Helado',gi:61,carbs:23,kcal:207},{name:'Brownie',gi:65,carbs:50,kcal:450},{name:'Tarta queso',gi:60,carbs:20,kcal:321},
    {name:'Magdalena',gi:70,carbs:55,kcal:450},{name:'Croissant',gi:67,carbs:45,kcal:406},{name:'Donut',gi:76,carbs:50,kcal:452},
    {name:'Arroz con leche',gi:70,carbs:20,kcal:150},{name:'Crepe',gi:60,carbs:30,kcal:220},{name:'Gofre',gi:67,carbs:50,kcal:291},
    {name:'Lentejas cocidas',gi:32,carbs:20,kcal:116},{name:'Garbanzos cocidos',gi:28,carbs:27,kcal:164},{name:'Frijoles negros',gi:30,carbs:23,kcal:132},
    {name:'Alubias blancas',gi:31,carbs:24,kcal:140},{name:'Edamame',gi:18,carbs:8.9,kcal:121},{name:'Tofu',gi:15,carbs:1.9,kcal:76},
    {name:'Tempeh',gi:15,carbs:9.4,kcal:193},{name:'Hummus',gi:6,carbs:14.3,kcal:166},{name:'Falafel',gi:43,carbs:30,kcal:333},
    {name:'Pollo pechuga',gi:0,carbs:0,kcal:165},{name:'Ternera',gi:0,carbs:0,kcal:250},{name:'Cerdo',gi:0,carbs:0,kcal:290},
    {name:'Cordero',gi:0,carbs:0,kcal:294},{name:'Salm√≥n',gi:0,carbs:0,kcal:208},{name:'At√∫n',gi:0,carbs:0,kcal:132},
    {name:'Huevos',gi:0,carbs:1.1,kcal:155},{name:'Queso fresco',gi:0,carbs:1.3,kcal:98},{name:'Queso curado',gi:0,carbs:1.3,kcal:402},
    {name:'Yogur natural',gi:36,carbs:4.7,kcal:61},{name:'Yogur griego',gi:35,carbs:3.6,kcal:120},{name:'Leche entera',gi:41,carbs:5,kcal:61,density:1.03},
    {name:'Leche desnatada',gi:32,carbs:5,kcal:35,density:1.03},{name:'Leche soja',gi:30,carbs:3,kcal:54,density:1.03},{name:'Leche almendra',gi:30,carbs:0.5,kcal:15,density:1.02},
    {name:'Kefir',gi:33,carbs:4,kcal:59},{name:'Requeson',gi:30,carbs:3.4,kcal:98},{name:'Quark',gi:30,carbs:4,kcal:67},
    {name:'Aguacate',gi:15,carbs:8.5,kcal:160},{name:'Manzana',gi:36,carbs:14,kcal:52},{name:'Pera',gi:38,carbs:15,kcal:57},
    {name:'Platano',gi:51,carbs:23,kcal:96},{name:'Fresas',gi:40,carbs:8,kcal:33},{name:'Uvas',gi:46,carbs:17,kcal:69},
    {name:'Naranja',gi:43,carbs:8.3,kcal:47},{name:'Kiwi',gi:52,carbs:15,kcal:61},{name:'Mango',gi:51,carbs:15,kcal:60},
    {name:'Pi√±a',gi:59,carbs:13,kcal:50},{name:'Melon',gi:65,carbs:8,kcal:34},{name:'Sandia',gi:76,carbs:8,kcal:30},
    {name:'Cereza',gi:63,carbs:16,kcal:63},{name:'Papaya',gi:60,carbs:10,kcal:43},{name:'Lima',gi:32,carbs:3.3,kcal:30},
    {name:'Tomate',gi:30,carbs:3.9,kcal:18},{name:'Zanahoria',gi:35,carbs:10,kcal:41},{name:'Cebolla',gi:10,carbs:9,kcal:40},
    {name:'Ajo',gi:30,carbs:33,kcal:149},{name:'Pimiento',gi:15,carbs:6,kcal:31},{name:'Lechuga',gi:15,carbs:2.9,kcal:15},
    {name:'Espinacas',gi:15,carbs:1.1,kcal:23},{name:'Brocoli',gi:10,carbs:7,kcal:34},{name:'Coliflor',gi:10,carbs:5,kcal:25},
    {name:'Champinones',gi:10,carbs:3.3,kcal:22},{name:'Calabacin',gi:15,carbs:3,kcal:17},{name:'Berenjena',gi:15,carbs:6,kcal:25},
    {name:'Maiz dulce',gi:52,carbs:19,kcal:86},{name:'Guisantes',gi:51,carbs:14,kcal:81},{name:'Semillas chia',gi:1,carbs:42,kcal:486},
    {name:'Semillas lino',gi:35,carbs:29,kcal:534},{name:'Almendras',gi:10,carbs:22,kcal:579},{name:'Avellanas',gi:15,carbs:17,kcal:628},
    {name:'Anacardos',gi:22,carbs:30,kcal:553},{name:'Pistachos',gi:15,carbs:28,kcal:562},{name:'Nueces',gi:15,carbs:14,kcal:654},
    {name:'Frutos secos mixtos',gi:20,carbs:30,kcal:600},{name:'Mantequilla',gi:0,carbs:0.1,kcal:717},{name:'Aceite oliva',gi:0,carbs:0,kcal:884,density:0.91},
    {name:'Mayonesa',gi:0,carbs:0.6,kcal:680},{name:'Salsa soja',gi:15,carbs:5,kcal:53},{name:'Ketchup',gi:55,carbs:22,kcal:112},
    {name:'Mostaza',gi:15,carbs:5,kcal:66},{name:'Mermelada',gi:55,carbs:65,kcal:250},{name:'Tahini',gi:0,carbs:17,kcal:595},
    {name:'Proteina whey',gi:30,carbs:5,kcal:120},{name:'Sopa pollo',gi:15,carbs:3,kcal:40,density:1.02},{name:'Caldo verduras',gi:15,carbs:2,kcal:15,density:1.02},
    {name:'Gazpacho',gi:25,carbs:6,kcal:48,density:1.02},{name:'Sushi',gi:55,carbs:28,kcal:200},{name:'Sashimi',gi:0,carbs:0,kcal:99},
    {name:'Tempura',gi:70,carbs:30,kcal:350},{name:'Hamburguesa',gi:50,carbs:10,kcal:295},{name:'Hot dog',gi:52,carbs:20,kcal:290},
    {name:'Empanada',gi:65,carbs:30,kcal:260},{name:'Croissant jamon',gi:67,carbs:45,kcal:406},{name:'Bocadillo jamon',gi:70,carbs:30,kcal:300},
    {name:'Wrap pollo',gi:50,carbs:25,kcal:220},{name:'Ensalada mixta',gi:15,carbs:5,kcal:80},{name:'Poke bowl',gi:55,carbs:45,kcal:420},
    {name:'Taco',gi:60,carbs:30,kcal:170},{name:'Burrito',gi:65,carbs:45,kcal:400},{name:'Nachos',gi:70,carbs:60,kcal:487},
    {name:'Patatas bravas',gi:78,carbs:30,kcal:200},{name:'Cerveza',gi:110,carbs:3.6,kcal:43,density:1.01},{name:'Vino tinto',gi:50,carbs:2.6,kcal:85,density:0.99},
    {name:'Vino blanco',gi:50,carbs:2.6,kcal:82,density:0.99},{name:'Refresco cola',gi:63,carbs:10.6,kcal:42,density:1.04},{name:'Zumo manzana',gi:40,carbs:11,kcal:46,density:1.04},
    {name:'Batido',gi:35,carbs:8,kcal:100,density:1.05},{name:'Cafe',gi:0,carbs:0,kcal:1,density:1.0},{name:'Te',gi:0,carbs:0,kcal:0,density:1.0},
    {name:'Kombucha',gi:50,carbs:3,kcal:15,density:1.02},{name:'Proteina vegetal',gi:30,carbs:6,kcal:110},{name:'Barrita energetica',gi:65,carbs:60,kcal:350},
    {name:'Bebida isotonica',gi:78,carbs:6,kcal:25,density:1.04},{name:'Salsa bechamel',gi:50,carbs:6,kcal:150},{name:'Pure manzana',gi:70,carbs:18,kcal:68},
    {name:'Compota',gi:65,carbs:20,kcal:80},{name:'Alitas pollo',gi:0,carbs:0,kcal:290},{name:'Pechuga asada',gi:0,carbs:0,kcal:165},
    {name:'Costillas',gi:0,carbs:0,kcal:360},{name:'Pescado frito',gi:0,carbs:0,kcal:220},{name:'Calamares',gi:0,carbs:0,kcal:175},
    {name:'Mejillones',gi:0,carbs:0,kcal:172},{name:'Paella',gi:65,carbs:30,kcal:280},{name:'Arroz negro',gi:65,carbs:30,kcal:290},
    {name:'Fideua',gi:65,carbs:35,kcal:300},{name:'Tortilla francesa',gi:0,carbs:1,kcal:154},{name:'Huevos revueltos',gi:0,carbs:1.5,kcal:160},{name:'Omelette',gi:0,carbs:2,kcal:200},
                         {name:'Pudding',gi:65,carbs:20,kcal:150},{name:'Flan',gi:65,carbs:18,kcal:140},{name:'Crema catalana',gi:70,carbs:25,kcal:220},
                         {name:'Sushi maki arroz',gi:55,carbs:28,kcal:200},{name:'Sushi california',gi:58,carbs:30,kcal:250},{name:'Onigiri',gi:60,carbs:35,kcal:210},
                         {name:'Snacks salados',gi:70,carbs:60,kcal:500},{name:'Palomitas',gi:65,carbs:74,kcal:375},{name:'Pretzels',gi:83,carbs:80,kcal:380},
                         {name:'Salsa pesto',gi:10,carbs:3,kcal:240},{name:'Salsa tomate casera',gi:30,carbs:6,kcal:40},{name:'Salsa barbacoa',gi:60,carbs:20,kcal:120},
                         {name:'Pickles',gi:15,carbs:2,kcal:11},{name:'Aceitunas',gi:15,carbs:3,kcal:145},{name:'Tapenade',gi:20,carbs:5,kcal:200},
                         {name:'Brocheta pollo',gi:0,carbs:0,kcal:170},{name:'Brocheta verduras',gi:20,carbs:8,kcal:80},{name:'Ratatouille',gi:20,carbs:10,kcal:120},
                         {name:'Lasagna',gi:66,carbs:28,kcal:300},{name:'Cannelloni',gi:64,carbs:30,kcal:320},{name:'Ravioli',gi:65,carbs:32,kcal:330},
                         {name:'Polenta',gi:68,carbs:20,kcal:86},{name:'Gnocchi',gi:64,carbs:30,kcal:130},{name:'Berenjena parmigiana',gi:40,carbs:12,kcal:220},
                         {name:'Sopa miso',gi:15,carbs:3,kcal:40},{name:'Ramen',gi:70,carbs:40,kcal:430},{name:'Udon',gi:70,carbs:40,kcal:350},
                         {name:'Salsa curry',gi:35,carbs:8,kcal:90},{name:'Curry pollo',gi:55,carbs:24,kcal:320},{name:'Curry verduras',gi:50,carbs:20,kcal:200},
                         {name:'Cuscus marroqui',gi:65,carbs:23,kcal:112},{name:'Tabbouleh',gi:50,carbs:18,kcal:120},{name:'Shawarma',gi:60,carbs:30,kcal:350},
                         {name:'Falafel wrap',gi:60,carbs:40,kcal:420},{name:'Shakshuka',gi:30,carbs:15,kcal:220},{name:'Labneh',gi:30,carbs:3,kcal:120},
                         {name:'Arepa',gi:55,carbs:45,kcal:230},{name:'Empanada argentina',gi:68,carbs:35,kcal:320},{name:'Tamal',gi:70,carbs:40,kcal:330},
                         {name:'Ceviche',gi:10,carbs:2,kcal:120},{name:'Pulpo a la gallega',gi:10,carbs:0,kcal:150},{name:'Bacalao',gi:0,carbs:0,kcal:140},
                         {name:'Croquetas',gi:70,carbs:25,kcal:250},{name:'Pat√©',gi:20,carbs:3,kcal:260},{name:'Foie',gi:15,carbs:2,kcal:462},
                         {name:'Sushi nigiri',gi:55,carbs:28,kcal:200},{name:'Sopa tom yum',gi:20,carbs:5,kcal:60},{name:'Pad thai',gi:68,carbs:45,kcal:450},
                         {name:'Couscous',gi:65,carbs:23,kcal:112},{name:'Bulgur',gi:46,carbs:76,kcal:342},{name:'Farro',gi:45,carbs:60,kcal:340},
                         {name:'Semola',gi:65,carbs:70,kcal:360},{name:'Triticale',gi:50,carbs:60,kcal:350},{name:'Kamut',gi:45,carbs:70,kcal:360},
                         {name:'Miso',gi:15,carbs:5,kcal:120},{name:'Natto',gi:20,carbs:12,kcal:200},{name:'Temaki',gi:58,carbs:30,kcal:280},
                         {name:'Sake',gi:60,carbs:4,kcal:134},{name:'Cider',gi:70,carbs:11,kcal:50},{name:'Sidra',gi:70,carbs:11,kcal:50}
                       ];

                       /* Trie for fast prefix search */
                       class TrieNode {
                         constructor() {
                           this.children = {};
                           this.words = [];
                           this.end = false;
                         }
                       }

                       class Trie {
                         constructor() {
                           this.root = new TrieNode();
                         }
                         insert(word, payload) {
                           let node = this.root;
                           const key = word.toLowerCase();
                           for (const ch of key) {
                             if (!node.children[ch]) node.children[ch] = new TrieNode();
                             node = node.children[ch];
                             if (node.words.length < 200) node.words.push(payload);
                           }
                           node.end = true;
                         }
                         searchPrefix(prefix) {
                           let node = this.root;
                           const key = (prefix || '').toLowerCase();
                           for (const ch of key) {
                             if (!node.children[ch]) return [];
                             node = node.children[ch];
                           }
                           return node.words || [];
                         }
                       }

                       let trie = new Trie();
                       const PAGE_SIZE = 30;
                       let modalPage = 0, currentFilter = '';

                       /* Modal functions */
                       function openModal() {
                         $('modalOverlay').style.display = 'flex';
                         $('modalSearch').value = '';
                         modalPage = 0;
                         currentFilter = '';
                         renderModal();
                         setTimeout(() => $('modalSearch').focus(), 100);
                       }

                       function closeModal(e) {
                         if (!e || (e.target && e.target.id === 'modalOverlay')) {
                           $('modalOverlay').style.display = 'none';
                         }
                       }

                       window.closeModal = closeModal;

                       async function renderModal() {
                         const list = $('modalList');
                         list.innerHTML = '';
                         try {
                           const results = currentFilter ? trie.searchPrefix(currentFilter) : await idbGetAll('alimentos');
                           const start = modalPage * PAGE_SIZE;
                           const page = results.slice(start, start + PAGE_SIZE);
                           
                           if (page.length === 0) {
                             list.innerHTML = '<div class="item">No se encontraron alimentos</div>';
                             return;
                           }

                           page.forEach(item => {
                             const d = document.createElement('div');
                             d.className = 'item';
                             d.innerText = item.name;
                             d.onclick = () => {
                               addRowWithAlimento(item.name);
                               closeModal();
                             };
                             list.appendChild(d);
                           });
                           renderPager(results.length);
                         } catch (err) {
                           console.error('renderModal', err);
                           list.innerHTML = '<div class="item">Error cargando alimentos</div>';
                         }
                       }

                       function renderPager(total) {
                         const pager = $('modalPager');
                         pager.innerHTML = '';
                         const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
                         if (pages <= 1) return;

                         const prev = document.createElement('button');
                         prev.className = 'btn small ghost';
                         prev.innerText = '¬´';
                         prev.onclick = () => {
                           if (modalPage > 0) {
                             modalPage--;
                             renderModal();
                           }
                         };

                         const next = document.createElement('button');
                         next.className = 'btn small ghost';
                         next.innerText = '¬ª';
                         next.onclick = () => {
                           if (modalPage < pages - 1) {
                             modalPage++;
                             renderModal();
                           }
                         };

                         pager.appendChild(prev);
                         const span = document.createElement('span');
                         span.innerText = (modalPage + 1) + ' / ' + pages;
                         pager.appendChild(span);
                         pager.appendChild(next);
                       }

                       /* Add row functions */
                       function addRowWithAlimento(name) {
                         try {
                           const tbody = $('cuerpoTabla');
                           const tr = document.createElement('tr');
                           
                           const tdName = document.createElement('td');
                           tdName.innerText = name;
                           tdName.dataset.name = name;

                           const tdQty = document.createElement('td');
                           const inp = document.createElement('input');
                           inp.type = 'number';
                           inp.value = 100;
                           inp.inputMode = 'decimal';
                           inp.setAttribute('aria-label', 'Cantidad');
                           tdQty.appendChild(inp);

                           const tdIG = document.createElement('td');
                           const tdCarbs = document.createElement('td');
                           const tdCG = document.createElement('td');
                           const tdKcal = document.createElement('td');
                           
                           const tdQ = document.createElement('td');
                           const btn = document.createElement('button');
                           btn.className = 'btn small danger';
                           btn.innerText = '‚úï';
                           btn.setAttribute('aria-label', 'Eliminar');
                           btn.onclick = () => {
                             tr.remove();
                             recalcAll();
                           };
                           tdQ.appendChild(btn);

                           tr.appendChild(tdName);
                           tr.appendChild(tdQty);
                           tr.appendChild(tdIG);
                           tr.appendChild(tdCarbs);
                           tr.appendChild(tdCG);
                           tr.appendChild(tdKcal);
                           tr.appendChild(tdQ);
                           
                           tbody.appendChild(tr);
                           inp.addEventListener('input', recalcAll);
                           
                           recalcAll();
                         } catch (err) {
                           console.error('addRow', err);
                         }
                       }

                       /* Render mobile cards */
                       function renderMobileCards() {
                         const container = $('tableCards');
                         container.innerHTML = '';
                         
                         const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
                         
                         filas.forEach(async (tr) => {
                           const name = tr.children[0].dataset.name;
                           const qty = Number(tr.querySelector('input').value) || 0;
                           
                           const item = await idbGet('alimentos', name) || seedAlimentos.find(a => a.name === name);
                           if (!item) return;

                           const unitMl = !!item.density;
                           const gramos = unitMl ? qty * (item.density || 1) : qty;
                           const carbs_g = gramos * (item.carbs / 100);
                           const cg_line = (item.gi * carbs_g) / 100;
                           const kcal_line = gramos * (item.kcal / 100);

                           const card = document.createElement('div');
                           card.className = 'food-card';
                           
                           card.innerHTML = `
                             <div class="food-card-header">
                               <div class="food-card-name">${name}</div>
                               <button class="btn small danger" onclick="this.closest('.food-card').remove(); recalcAll();">‚úï</button>
                             </div>
                             <div class="food-card-body">
                               <div class="food-card-field">
                                 <div class="food-card-label">Cantidad (${unitMl ? 'ml' : 'g'})</div>
                                 <input type="number" class="food-card-input" value="${qty}" data-name="${name}" inputmode="decimal">
                               </div>
                               <div class="food-card-field">
                                 <div class="food-card-label">IG</div>
                                 <div class="food-card-value">${item.gi}</div>
                               </div>
                               <div class="food-card-field">
                                 <div class="food-card-label">Carbs (g)</div>
                                 <div class="food-card-value">${round(carbs_g, 2)}</div>
                               </div>
                               <div class="food-card-field">
                                 <div class="food-card-label">CG</div>
                                 <div class="food-card-value">${round(cg_line, 2)}</div>
                               </div>
                               <div class="food-card-field">
                                 <div class="food-card-label">Kcal</div>
                                 <div class="food-card-value">${round(kcal_line, 1)}</div>
                               </div>
                             </div>
                           `;
                           
                           const input = card.querySelector('input');
                           input.addEventListener('input', (e) => {
                             const newQty = Number(e.target.value) || 0;
                             const correspondingTr = Array.from(document.querySelectorAll('#cuerpoTabla tr')).find(
                               row => row.children[0].dataset.name === name
                             );
                             if (correspondingTr) {
                               correspondingTr.querySelector('input').value = newQty;
                             }
                             recalcAll();
                           });
                           
                           container.appendChild(card);
                         });
                       }

                       /* Recalculate all values */
                       async function recalcAll() {
                         try {
                           const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
                           let CG_total = 0, kcal_total = 0, carbs_total = 0, ig_pes_num = 0;

                           for (const tr of filas) {
                             const name = tr.children[0].dataset.name;
                             const qty = Number(tr.querySelector('input').value) || 0;
                             const item = await idbGet('alimentos', name) || seedAlimentos.find(a => a.name === name);
                             
                             if (!item) {
                               tr.children[2].innerText = '-';
                               tr.children[3].innerText = '0';
                               tr.children[4].innerText = '0';
                               tr.children[5].innerText = '0';
                               continue;
                             }

                             const unitMl = !!item.density;
                             const gramos = unitMl ? qty * (item.density || 1) : qty;
                             const carbs_g = gramos * (item.carbs / 100);
                             const cg_line = (item.gi * carbs_g) / 100;
                             const kcal_line = gramos * (item.kcal / 100);

                             tr.children[2].innerText = item.gi;
                             tr.children[3].innerText = round(carbs_g, 2);
                             tr.children[4].innerText = round(cg_line, 2);
                             tr.children[5].innerText = round(kcal_line, 1);

                             CG_total += cg_line;
                             kcal_total += kcal_line;
                             carbs_total += carbs_g;
                             ig_pes_num += (item.gi * carbs_g);
                           }

                           const ig_ponderado = carbs_total ? (ig_pes_num / carbs_total) : 0;
                           const perfil = JSON.parse(localStorage.getItem('perfilUsuario') || 'null');
                           const peso = perfil ? Number(perfil.peso) : 70;
                           const ire = peso ? (CG_total / peso) : 0;
                           const vg = kcal_total ? ((CG_total / kcal_total) * 100) : 0;

                           $('resultado').innerText = `CG total: ${round(CG_total, 2)} | Kcal total: ${Math.round(kcal_total)}`;
                           $('igprom').innerText = round(ig_ponderado, 1);
                           $('iretext').innerText = round(ire, 2);
                           $('vgtext').innerText = round(vg, 2);

                           // Update bars
                           const cgPercent = Math.min(100, (CG_total / 100) * 100);
                           const cgBar = $('cgbar');
                           cgBar.style.width = cgPercent + '%';
                           $('cgvalue').innerText = round(CG_total, 2);
                           cgBar.classList.remove('low', 'medium', 'high');
                           if (CG_total < 20) cgBar.classList.add('low');
                           else if (CG_total < 50) cgBar.classList.add('medium');
                           else cgBar.classList.add('high');

                           const irePercent = Math.min(100, (ire / 2) * 100);
                           const ireBar = $('irebar');
                           ireBar.style.width = irePercent + '%';
                           ireBar.classList.remove('low', 'medium', 'high');
                           if (ire < 0.7) ireBar.classList.add('low');
                           else if (ire < 1.2) ireBar.classList.add('medium');
                           else ireBar.classList.add('high');

                           const vgPercent = Math.min(100, vg);
                           const vgBar = $('vgbar');
                           vgBar.style.width = vgPercent + '%';
                           vgBar.classList.remove('low', 'medium', 'high');
                           if (vg < 10) vgBar.classList.add('low');
                           else if (vg < 25) vgBar.classList.add('medium');
                           else vgBar.classList.add('high');

                           // Update mobile cards if visible
                           if (window.innerWidth <= 768) {
                             renderMobileCards();
                           }

                         } catch (err) {
                           console.error('recalcAll', err);
                         }
                       }

                       /* Profile functions */
                       $('guardarPerfil').onclick = () => {
                         try {
                           const perfil = {
                             nombre: $('nombre').value,
                             sexo: $('sexo').value,
                             edad: Number($('edad').value),
                             peso: Number($('peso').value),
                             talla: Number($('talla').value)
                           };
                           localStorage.setItem('perfilUsuario', JSON.stringify(perfil));
                           $('infoPerfil').innerText = `Perfil guardado: ${perfil.nombre}, ${perfil.edad} a√±os, ${perfil.peso} kg`;
                           recalcAll();
                         } catch (err) {
                           console.error('guardarPerfil', err);
                           alert('Error al guardar perfil');
                         }
                       };

                       $('cargarPerfil').onclick = () => {
                         try {
                           const perfil = JSON.parse(localStorage.getItem('perfilUsuario') || 'null');
                           if (!perfil) {
                             alert('No hay perfil guardado');
                             return;
                           }
                           $('nombre').value = perfil.nombre || '';
                           $('sexo').value = perfil.sexo || 'M';
                           $('edad').value = perfil.edad || '';
                           $('peso').value = perfil.peso || '';
                           $('talla').value = perfil.talla || '';
                           $('infoPerfil').innerText = `Perfil cargado: ${perfil.nombre}, ${perfil.edad} a√±os, ${perfil.peso} kg`;
                           recalcAll();
                         } catch (err) {
                           console.error('cargarPerfil', err);
                           alert('Error al cargar perfil');
                         }
                       };

                       /* Search and add */
                       $('buscador').addEventListener('input', (e) => {
                         const query = e.target.value.trim();
                         if (query.length >= 2) {
                           const results = trie.searchPrefix(query);
                           console.log(`Encontrados ${results.length} resultados para "${query}"`);
                         }
                       });

                       $('addBtn').onclick = async () => {
                         const query = $('buscador').value.trim();
                         if (!query) {
                           alert('Escribe el nombre de un alimento');
                           return;
                         }
                         const results = trie.searchPrefix(query);
                         if (results.length === 0) {
                           alert('No se encontr√≥ el alimento');
                           return;
                         }
                         addRowWithAlimento(results[0].name);
                         $('buscador').value = '';
                       };

                       $('openModalBtn').onclick = openModal;

                       $('modalSearch').addEventListener('input', (e) => {
                         currentFilter = e.target.value.trim();
                         modalPage = 0;
                         renderModal();
                       });

                       /* Clear table */
                       $('clearBtn').onclick = () => {
                         if (confirm('¬øSeguro que quieres limpiar toda la tabla?')) {
                           $('cuerpoTabla').innerHTML = '';
                           $('tableCards').innerHTML = '';
                           recalcAll();
                         }
                       };

                       /* Export CSV */
                       $('exportCSV').onclick = () => {
                         try {
                           const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
                           if (filas.length === 0) {
                             alert('No hay datos para exportar');
                             return;
                           }

                           let csv = 'Alimento,Cantidad,IG,Carbs,CG,Kcal\n';
                           filas.forEach(tr => {
                             const cells = Array.from(tr.children).slice(0, 6);
                             const row = cells.map(td => {
                               const input = td.querySelector('input');
                               return input ? input.value : td.innerText;
                             }).join(',');
                             csv += row + '\n';
                           });

                           const blob = new Blob([csv], { type: 'text/csv' });
                           const url = URL.createObjectURL(blob);
                           const a = document.createElement('a');
                           a.href = url;
                           a.download = `calculadora_glucemica_${new Date().toISOString().split('T')[0]}.csv`;
                           a.click();
                           URL.revokeObjectURL(url);
                         } catch (err) {
                           console.error('exportCSV', err);
                           alert('Error al exportar CSV');
                         }
                       };

                       /* Export PDF */
                       $('exportPDF').onclick = () => {
                         try {
                           const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
                           if (filas.length === 0) {
                             alert('No hay datos para exportar');
                             return;
                           }

                           const { jsPDF } = window.jspdf;
                           const doc = new jsPDF();

                           doc.setFontSize(18);
                           doc.text('Calculadora Gluc√©mica', 14, 20);
                           
                           doc.setFontSize(11);
                           doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 28);
                           doc.text(`Tipo de comida: ${$('tipoComida').value}`, 14, 34);

                           const perfil = JSON.parse(localStorage.getItem('perfilUsuario') || 'null');
                           if (perfil) {
                             doc.text(`Perfil: ${perfil.nombre} - ${perfil.peso} kg`, 14, 40);
                           }

                           const tableData = filas.map(tr => {
                             const cells = Array.from(tr.children).slice(0, 6);
                             return cells.map(td => {
                               const input = td.querySelector('input');
                               return input ? input.value : td.innerText;
                             });
                           });

                           doc.autoTable({
                             head: [['Alimento', 'Cantidad', 'IG', 'Carbs', 'CG', 'Kcal']],
                             body: tableData,
                             startY: 46,
                             theme: 'grid',
                             headStyles: { fillColor: [46, 139, 87] }
                           });

                           const finalY = doc.lastAutoTable.finalY + 10;
                           doc.setFontSize(12);
                           doc.text($('resultado').innerText, 14, finalY);
                           doc.text(`IG ponderado: ${$('igprom').innerText}`, 14, finalY + 7);
                           doc.text(`IRE: ${$('iretext').innerText} | VG: ${$('vgtext').innerText}`, 14, finalY + 14);

                           doc.save(`calculadora_glucemica_${new Date().toISOString().split('T')[0]}.pdf`);
                         } catch (err) {
                           console.error('exportPDF', err);
                           alert('Error al exportar PDF');
                         }
                       };

                       /* Scanner */
                       let scannerActive = false;

                       $('scanBtn').onclick = () => {
                         if (scannerActive) {
                           stopScanner();
                         } else {
                           startScanner();
                         }
                       };

                       function startScanner() {
                         try {
                           $('scanStatus').innerText = 'Iniciando c√°mara...';
                           $('video').style.display = 'block';
                           
                           Quagga.init({
                             inputStream: {
                               name: "Live",
                               type: "LiveStream",
                               target: $('video'),
                               constraints: {
                                 facingMode: "environment"
                               }
                             },
                             decoder: {
                               readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader"]
                             }
                           }, (err) => {
                             if (err) {
                               console.error('Quagga init error:', err);
                               $('scanStatus').innerText = 'Error al iniciar c√°mara';
                               return;
                             }
                             Quagga.start();
                             scannerActive = true;
                             $('scanStatus').innerText = 'Escaneando... (apunta al c√≥digo de barras)';
                             $('scanBtn').innerText = '‚èπÔ∏è Detener';
                           });

                           Quagga.onDetected((data) => {
                             const code = data.codeResult.code;
                             $('scanStatus').innerText = `C√≥digo detectado: ${code}`;
                             console.log('C√≥digo escaneado:', code);
                             stopScanner();
                             // Aqu√≠ podr√≠as buscar el c√≥digo en una base de datos
                             alert(`C√≥digo escaneado: ${code}\n(Funci√≥n de b√∫squeda por implementar)`);
                           });
                         } catch (err) {
                           console.error('startScanner', err);
                           $('scanStatus').innerText = 'Error al iniciar esc√°ner';
                         }
                       }

                       function stopScanner() {
                         try {
                           Quagga.stop();
                           scannerActive = false;
                           $('video').style.display = 'none';
                           $('scanStatus').innerText = 'Inactivo';
                           $('scanBtn').innerText = 'üì∑ Escanear';
                         } catch (err) {
                           console.error('stopScanner', err);
                         }
                       }

                       /* Recipes / Templates */
                       let recipes = [];

                       async function loadRecipes() {
                         try {
                           recipes = await idbGetAll('recipes');
                           const select = $('recipesSelect');
                           select.innerHTML = '<option value="">-- Selecciona plantilla --</option>';
                           recipes.forEach(r => {
                             const opt = document.createElement('option');
                             opt.value = r.id;
                             opt.innerText = r.name;
                             select.appendChild(opt);
                           });
                         } catch (err) {
                           console.error('loadRecipes', err);
                         }
                       }

                       $('saveRecipeBtn').onclick = async () => {
                         try {
                           const filas = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
                           if (filas.length === 0) {
                             alert('No hay alimentos para guardar');
                             return;
                           }

                           const name = prompt('Nombre de la plantilla:');
                           if (!name) return;

                           const items = [];
                           for (const tr of filas) {
                             const itemName = tr.children[0].dataset.name;
                             const qty = Number(tr.querySelector('input').value) || 0;
                             items.push({ name: itemName, qty });
                           }

                           const recipe = {
                             id: Date.now().toString(),
                             name: name,
                             items: items,
                             created: new Date().toISOString()
                           };

                           await idbPut('recipes', recipe);
                           alert('Plantilla guardada correctamente');
                           loadRecipes();
                         } catch (err) {
                           console.error('saveRecipe', err);
                           alert('Error al guardar plantilla');
                         }
                       };

                       $('loadRecipeBtn').onclick = async () => {
                         try {
                           const recipeId = $('recipesSelect').value;
                           if (!recipeId) {
                             alert('Selecciona una plantilla');
                             return;
                           }

                           const recipe = await idbGet('recipes', recipeId);
                           if (!recipe) {
                             alert('Plantilla no encontrada');
                             return;
                           }

                           if (confirm(`¬øCargar plantilla "${recipe.name}"? Esto limpiar√° la tabla actual.`)) {
                             $('cuerpoTabla').innerHTML = '';
                             $('tableCards').innerHTML = '';
                             
                             recipe.items.forEach(item => {
                               addRowWithAlimento(item.name);
                               // Set quantity after a small delay to ensure row is created
                               setTimeout(() => {
                                 const rows = Array.from(document.querySelectorAll('#cuerpoTabla tr'));
                                 const row = rows.find(r => r.children[0].dataset.name === item.name);
                                 if (row) {
                                   row.querySelector('input').value = item.qty;
                                   recalcAll();
                                 }
                               }, 100);
                             });
                           }
                         } catch (err) {
                           console.error('loadRecipe', err);
                           alert('Error al cargar plantilla');
                         }
                       };

                       /* PWA Install */
                       let deferredPrompt;

                       window.addEventListener('beforeinstallprompt', (e) => {
                         e.preventDefault();
                         deferredPrompt = e;
                         $('installBtn').style.display = 'inline-flex';
                       });

                       $('installBtn').onclick = async () => {
                         if (!deferredPrompt) return;
                         deferredPrompt.prompt();
                         const { outcome } = await deferredPrompt.userChoice;
                         console.log(`Install prompt outcome: ${outcome}`);
                         deferredPrompt = null;
                         $('installBtn').style.display = 'none';
                       };

                       /* Tests */
                       $('runTestsBtn').onclick = () => {
                         try {
                           console.log('=== Ejecutando Tests ===');
                           
                           // Test 1: Trie search
                           const results = trie.searchPrefix('pan');
                           console.log(`‚úì Test 1: B√∫squeda Trie - Encontrados ${results.length} resultados para "pan"`);
                           
                           // Test 2: Add alimento
                           addRowWithAlimento('Manzana');
                           console.log('‚úì Test 2: Agregar alimento - Manzana agregada');
                           
                           // Test 3: Calculation
                           setTimeout(() => {
                             const cg = $('cgvalue').innerText;
                             console.log(`‚úì Test 3: C√°lculo CG - CG total: ${cg}`);
                           }, 500);
                           
                           // Test 4: Profile
                           const perfil = localStorage.getItem('perfilUsuario');
                           console.log(`‚úì Test 4: Perfil - ${perfil ? 'Perfil encontrado' : 'Sin perfil'}`);
                           
                           // Test 5: IndexedDB
                           idbGetAll('alimentos').then(items => {
                             console.log(`‚úì Test 5: IndexedDB - ${items.length} alimentos en base de datos`);
                           });
                           
                           console.log('=== Tests Completados ===');
                           alert('Tests ejecutados. Revisa la consola para ver resultados.');
                         } catch (err) {
                           console.error('Error en tests:', err);
                           alert('Error al ejecutar tests');
                         }
                       };

                       /* Responsive handling */
                       function handleResize() {
                         if (window.innerWidth <= 768) {
                           renderMobileCards();
                         }
                       }

                       window.addEventListener('resize', handleResize);

                       /* Initialize */
                       async function init() {
                         try {
                           console.log('Inicializando aplicaci√≥n...');
                           
                           // Open IndexedDB
                           await openDB();
                           console.log('‚úì IndexedDB abierta');

                           // Load seed data
                           const existingItems = await idbGetAll('alimentos');
                           if (existingItems.length === 0) {
                             console.log('Cargando datos semilla...');
                             for (const item of seedAlimentos) {
                               await idbPut('alimentos', item);
                               trie.insert(item.name, item);
                             }
                             console.log(`‚úì ${seedAlimentos.length} alimentos cargados`);
                           } else {
                             console.log(`‚úì ${existingItems.length} alimentos ya en base de datos`);
                             existingItems.forEach(item => trie.insert(item.name, item));
                           }

                           // Load recipes
                           await loadRecipes();
                           console.log('‚úì Plantillas cargadas');

                           // Load profile if exists
                           const perfil = JSON.parse(localStorage.getItem('perfilUsuario') || 'null');
                           if (perfil) {
                             $('nombre').value = perfil.nombre || '';
                             $('sexo').value = perfil.sexo || 'M';
                             $('edad').value = perfil.edad || '';
                             $('peso').value = perfil.peso || '';
                             $('talla').value = perfil.talla || '';
                             $('infoPerfil').innerText = `Perfil cargado: ${perfil.nombre}, ${perfil.edad} a√±os, ${perfil.peso} kg`;
                             console.log('‚úì Perfil de usuario cargado');
                           }

                           // Collapse profile on mobile by default
                           if (window.innerWidth <= 768) {
                             toggleProfile();
                           }

                           // Initial render
                           handleResize();
                           
                           console.log('‚úì Aplicaci√≥n inicializada correctamente');
                           
                           // Show welcome message
                           const notice = $('localNotice');
                           notice.style.display = 'block';
                           notice.innerHTML = `
                             <strong>‚ú® Bienvenido a Calculadora Gluc√©mica</strong><br>
                             Base de datos: ${existingItems.length || seedAlimentos.length} alimentos disponibles<br>
                             ${perfil ? `Perfil activo: ${perfil.nombre}` : 'Configura tu perfil para c√°lculos personalizados'}
                           `;
                           setTimeout(() => {
                             notice.style.display = 'none';
                           }, 5000);

                         } catch (err) {
                           console.error('Error en inicializaci√≥n:', err);
                           alert('Error al inicializar la aplicaci√≥n. Recarga la p√°gina.');
                         }
                       }

                       /* Service Worker Registration */
                       if ('serviceWorker' in navigator) {
                         window.addEventListener('load', () => {
                           navigator.serviceWorker.register('/sw.js')
                             .then(reg => console.log('‚úì Service Worker registrado'))
                             .catch(err => console.log('Service Worker error:', err));
                         });
                       }

                       /* Start app */
                       if (document.readyState === 'loading') {
                         document.addEventListener('DOMContentLoaded', init);
                       } else {
                         init();
                       }

                     })();
                     </script>
                     </body>
                     </html>
